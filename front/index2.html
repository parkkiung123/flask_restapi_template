<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>画像処理（グレースケール & 顔抽出）</title>  
</head>
<body>
  <h2>オリジナル画像</h2>
  <input type="file" id="imageInput" accept="image/*"><br>
  <img id="original-image" src="" alt="オリジナル画像" style="max-width: 300px; display: none;"><br><br>

  <!-- 処理ボタン -->
  <button id="convertButton">グレースケール変換</button>
  <button id="faceButton">顔抽出</button>
  <button id="kotenOCRButton">古典籍OCR</button>

  <!-- 処理結果表示 -->
  <h2 id="result-title">変換後の画像</h2>
  <div id="loading" style="display: none; color: red; font-weight: bold;">読み込み中...しばらくお待ちください</div>
  <img id="result-image" src="" alt="処理画像" style="max-width: 300px; display: none;"><br>

  <div id="ocr-div" style="display: none;">
    <h3>OCR結果</h3>
    <div id="ocr-result" style="white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; max-width: 300px;"></div>
  </div>  

  <script>
    const imageInput = document.getElementById('imageInput');
    const originalImage = document.getElementById('original-image');
    const resultImage = document.getElementById('result-image');
    const resultTitle = document.getElementById('result-title');
    const convertButton = document.getElementById('convertButton');
    const faceButton = document.getElementById('faceButton');
    const kotenOCRButton = document.getElementById('kotenOCRButton');
    const loadingDiv = document.getElementById('loading');
    const ocrDiv = document.getElementById('ocr-div');

    var ocr_bool = false;
    let base64Image = '';

    // 画像ファイルを読み込んでbase64に変換
    imageInput.addEventListener('change', () => {
      const file = imageInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          base64Image = e.target.result.split(',')[1];
          originalImage.src = e.target.result;
          originalImage.style.display = 'block';
          resultImage.style.display = 'none';
        };
        reader.readAsDataURL(file);
      }
    });

    // 共通処理関数
    function processImage(apiUrl, titleText) {
      if (!base64Image) {
        alert('画像を選択してください。');
        return;
      }

      // スピナー表示
      loadingDiv.style.display = 'block';
      if (!ocr_bool) {
        ocrDiv.style.display = 'none';
      }

      fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image: base64Image })
      })
      .then(response => response.json())
      .then(data => {
        loadingDiv.style.display = 'none'; // スピナー非表示     
        if (data.image) {
          resultTitle.textContent = titleText;
          resultImage.src = 'data:image/jpeg;base64,' + data.image;
          resultImage.style.display = 'block';
          if (ocr_bool) {               
            ocrDiv.style.display = 'block';
            const ocrJson = JSON.parse(data.json);
            const ocrResultDiv = document.getElementById('ocr-result');
            if (ocrJson.contents &&
                ocrJson.contents.length > 0 &&
                Array.isArray(ocrJson.contents[0]) &&
                ocrJson.contents[0].length > 0) {
              const lines = ocrJson.contents[0]
                .map(obj => obj.text)
                .join('\n');
              ocrResultDiv.textContent = lines;
            } else {
              ocrResultDiv.textContent = 'OCR結果がありません。';
            }
            ocr_bool = false
          }
        } else {
          alert(`${titleText} に失敗しました。`);
        }
      })
      .catch(error => {
        loadingDiv.style.display = 'none'; // スピナー非表示
        console.error('エラー:', error);
        alert('通信エラーが発生しました。');
      });
    }

    // 各ボタンに処理を割り当て
    convertButton.addEventListener('click', () => {   
      processImage('http://localhost:5000/api/v1/image/gray/base64', 'グレースケール画像');
    });

    faceButton.addEventListener('click', () => {
      processImage('http://localhost:5000/api/v1/image/cropFace/base64', '抽出された顔画像');
    });

    kotenOCRButton.addEventListener('click', () => {
      ocr_bool = true
      processImage('http://localhost:5000/api/v1/image/kotenOCR/base64', '古典籍画像の認識結果');
    });
  </script>
</body>
</html>
