<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Face Distance Real-time Graph</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>Face Distance (cm) - Last 1 Hour</h2>
  <canvas id="faceDistChart" width="800" height="400"></canvas>

  <script>
    const apiUrl = "http://localhost:5000/api/v1/sensor/get/"
    const device_id = "face_dist_001"
    const time_mode = "local" // "local" or "utc"
    const ctx = document.getElementById('faceDistChart').getContext('2d');
    let chart;

    function extractSensorData(sensorJsonList) {
        return sensorJsonList.map(sensor => {
            const data = sensor.data || {};
            return {
            unit: data.unit || null,
            value: data.value || null,            
            status: sensor.status || null,
            timestamp: sensor.timestamp || null,
            };
        });
    }

    async function fetchData() {
      const res = await fetch(apiUrl + device_id);
      const data = extractSensorData(await res.json());
      return data;
    }

    function formatTime(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleTimeString(); // 時:分:秒形式
    }

    async function initChart() {
      const data = await fetchData();

      console.log(data);

      const labels = data.map(d => formatTime(d.timestamp));
      const values = data.map(d => d.value);

      if (!chart) {
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Face Distance ' + (data[0].unit || 'cm'),
              data: values,
              borderColor: 'rgba(75, 192, 192, 1)',
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              fill: true,
              tension: 0.1
            }]
          },
          options: {
            scales: {
              x: {
                title: { display: true, text: 'Time' },
                ticks: { maxRotation: 45, minRotation: 45 }
              },
              y: {
                title: { display: true, text: 'Distance (cm)' },
                beginAtZero: true
              }
            }
          }
        });
      } else {
        chart.data.labels = labels;
        chart.data.datasets[0].data = values;
        chart.update();
      }
    }

    initChart().then(() => {
      console.log("Chart initialized");
    });


    

    // async function updateChart() {
    //   const data = await fetchData();

      
    // }

    // // 初回描画＋10秒毎に更新
    // updateChart();
    // setInterval(updateChart, 10000);
  </script>
</body>
</html>
